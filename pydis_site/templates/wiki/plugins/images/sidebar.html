{% load i18n wiki_tags wiki_images_tags humanize wiki_thumbnails sekizai_tags %}


{% addtoblock "js" %}
<script type="text/javascript">
function insert_image(data) {
    if (typeof data == "number") {
        image_id = data;
        $("#img_title").text(" {{ _("Insert Image")|escapejs }} " + image_id);
        $("#img_modal").on('shown.bs.modal', function(){
            $(this).find('#img_caption').focus();
        });
        $("#img_modal").modal();
   } else {
        align = data.img_align.options[data.img_align.selectedIndex].text;
        size = data.img_size.options[data.img_size.selectedIndex].text;
        caption = data.img_caption.value;

        data.img_align.selectedIndex = 0;
        data.img_size.selectedIndex = 0;
        data.img_caption.value = "";

        tag = '\n[image:'+image_id;
        if (align != "center") tag = tag + ' align:'+align;
        if (size != "default") tag = tag + ' size:'+size;

        if (caption == '')
            $('#id_content').insertAtCaret(tag+']\n\n');
        else
            $('#id_content').insertAtCaret(tag+']\n    '+caption+'\n\n');
    }
}
function add_image(form) {
    $(form).submit();
}
</script>
{% endaddtoblock %}

{% with article|images_for_article as images %}
<style type="text/css">
  #image-list tr:first-child td {border:0;}
</style>

{% if article|images_can_add:user %}
  {% include "wiki/includes/formerrors.html" %}

  {# Include the hidden fields #}
  {% for hidden in form.hidden_fields %}
    {{ hidden }}
  {% endfor %}

  {% for field in form.visible_fields %}
    {% include "wiki/includes/formfield.html" with render_labels=False %}
  {% endfor %}

  <button type="button" onClick="add_image(this.form)" name="{{ plugin.slug }}_save" value="1" class="button is-primary is-fullwidth">
    <span class="icon">
      <i class="fas fa-upload"></i>
    </span>
    <span>Upload</span>
  </button>
{% endif %}

<div class="is-divider"></div>

{% for image in images %}
  {% with image.current_revision.imagerevision as revision %}
    {% thumbnail revision.image "100x100" crop="center" as thumb %}
      <div class="columns">
        <div class="column is-half">
          <img src="{{ thumb.url }}" alt="{{ revision.get_filename }}" title="{{ revision.get_filename }}" />
        </div>
        <div class="column is-half has-text-right">
          <div class="tags is-right">
            <span class="tag is-dark is-medium">Image ID: {{ image.id }}</span>
          </div>

          <p>
            <a class="button is-primary" title="Insert image" href="javascript:void(insert_image({{ image.id }}))">
              <span class="icon">
                <i class="fa fa-paste"></i>
              </span>
            </a>

            {% if image|can_write:user %}
              <a class="button is-primary" title="Replace" href="{% url 'wiki:images_add_revision' path=urlpath.path article_id=article.id image_id=image.id %}">
                <span class="icon">
                  <i class="fas fa-upload"></i>
                </span>
              </a>
            {% endif %}
          </p>
        </div>
      </div>
    {% endthumbnail %}
  {% endwith %}
{% empty %}
  <em>No images found for this article</em>
{% endfor %}

<p>
  <a class="button is-primary is-fullwidth" href="{% url 'wiki:images_index' path=urlpath.path article_id=article.id %}">
    <span>Manage Images</span>
    <span class="icon">
      <i class="fas fa-arrow-right"></i>
    </span>
  </a>
</p>
<hr />

<hr />

<h4>
  {% trans "How to use images" %}
</h4>

<p>{% trans "After uploading an image, it is attached to this particular article and can be used only here. Other users may replace the image, but older versions are kept. To show the image press the Insert button and select the options you want to use. You can use Markdown in the caption. The Markdown code syntax for images looks like this" %}<br/>
<pre>[image:id align:right size:orig]
    caption indented by 4 spaces</pre>
{% trans "Possible values for align are" %} <pre>left | right</pre>
{% trans "Possible values for size are" %} <pre>small | medium | large | orig | default</pre>
</p>
{% endwith %}

<div class="modal" id="img_modal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content" style="position:relative !important;">
      <div class="modal-header">
        <h4 id="img_title"></h4>
      </div>
      <div class="modal-body">
        <form role="form">
          <div class="form-group" style="margin-left:0; margin-right:0;">
            <label for="img_align">{% trans "Alignment" %}</label>
            <select class="form-control" id="img_align">
              <option>center</option>
              <option>left</option>
              <option>right</option>
            </select>
          </div>
          <div class="form-group" style="margin-left:0; margin-right:0;">
            <label for="img_size">{% trans "Size" %}</label>
            <select class="form-control" id="img_size">
              <option>default</option>
              <option>small</option>
              <option>medium</option>
              <option>large</option>
              <option>orig</option>
            </select>
          </div>
          <div class="form-group" style="margin-left:0; margin-right:0;">
            <label for="img_caption">{% trans "Caption" %}</label>
            <input type="text" class="form-control" id="img_caption" placeholder="{% trans "Enter caption" %}">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success btn-default" data-dismiss="modal" onClick="insert_image(this.form)"> {% trans "Insert image" %} </button>
        <button class="btn btn-danger" data-dismiss="modal"> {% trans "Cancel" %} </button>
      </div>
    </div>
  </div>
</div>
